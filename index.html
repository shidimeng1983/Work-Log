<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>ç”Ÿç‰©è¯•å‰‚é”€å”®ç®¡ç†å·¥ä½œå°</title>
    <!-- Mobile Optimization -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å·¥ä½œè®°äº‹æœ¬">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            /* Palette: Modern & Minimalist */
            --primary-bg: #F7F9FC;
            --sidebar-bg: #ffffff;
            --sidebar-text: #64748b;
            --sidebar-active-bg: #e2e8f0;
            --sidebar-active-text: #0f172a;

            --accent-color: #3b82f6;
            /* Modern Blue */
            --accent-hover: #2563eb;

            --text-main: #1e293b;
            --text-secondary: #64748b;

            --card-bg: #ffffff;
            --border-color: #e2e8f0;

            --radius-md: 12px;
            --radius-sm: 8px;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sidebar-width: 240px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            line-height: 1.4;
            /* Reduced from 1.6 */
            -webkit-font-smoothing: antialiased;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px 12px;
            /* Reduced padding */
            box-sizing: border-box;
        }

        .app-title {
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 25px;
            /* Reduced from 40px */
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .nav-item {
            padding: 10px 12px;
            /* Reduced padding */
            margin-bottom: 2px;
            /* Reduced margin */
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--sidebar-text);
            font-size: 14px;
            font-weight: 500;
            border-left: none;
            /* Removed heavy border */
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background-color: var(--primary-bg);
            color: var(--text-main);
        }

        .nav-item.active {
            background-color: var(--sidebar-active-bg);
            color: var(--accent-color);
            /* Highlight text instead of border */
            font-weight: 600;
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            padding: 20px 24px;
            /* Reduced padding */
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            max-width: 1200px;
            /* Limit width for reading ease */
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            /* Reduced margin */
        }

        #module-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        #current-date {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        /* --- Module Sections --- */
        .module-section {
            display: none;
            flex-direction: column;
            gap: 15px;
            /* Reduced gap */
            height: 100%;
        }

        .module-section.active {
            display: flex;
        }

        /* --- Cards (Unified Style) --- */
        .top-reminders,
        .input-area,
        .history-area,
        .module-section#search {
            background: var(--card-bg);
            padding: 16px;
            /* Reduced padding */
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        /* Remove colored borders, use badges/header colors if needed. But minimal is better. */
        .top-reminders {
            border-left: none;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            /* Reduced margin */
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
        }

        /* --- Lists --- */
        .reminder-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .reminder-list li {
            padding: 6px 0;
            /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            font-size: 14px;
            transition: background 0.2s;
        }

        .reminder-list li:hover {
            background-color: #f8fafc;
            padding-left: 8px;
            /* subtle nudge */
            margin-left: -8px;
            margin-right: -8px;
            padding-right: 8px;
            border-radius: 4px;
        }

        .reminder-list li:last-child {
            border-bottom: none;
        }

        .reminder-list li input[type="checkbox"] {
            margin-right: 12px;
            accent-color: var(--accent-color);
            width: 16px;
            height: 16px;
        }

        /* --- Forms --- */
        textarea,
        input[type="text"],
        input[type="date"],
        .main-search-input {
            width: 100%;
            padding: 12px 16px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background-color: #f8fafc;
            transition: all 0.2s;
            font-family: inherit;
            resize: vertical;
            /* Allow vertical resize only */
        }

        textarea:focus,
        input:focus,
        .main-search-input:focus {
            outline: none;
            background-color: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            height: 120px;
            margin-bottom: 16px;
        }

        /* --- Buttons --- */
        .action-bar {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            /* Right align buttons */
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-add-reminder {
            background-color: #f59e0b;
            color: white;
        }

        /* Amber 500 */
        .btn-save-log {
            background-color: var(--accent-color);
            color: white;
        }

        /* Blue 500 */
        .btn-print {
            background-color: #64748b;
            color: white;
        }

        /* Slate 500 */

        /* --- History --- */
        .history-area {
            flex: 1;
            overflow-y: auto;
            margin-top: 0;
            border-top: none;
        }

        /* removed margin-top as it's flex gap now */

        .history-item {
            padding: 10px 0;
            /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            /* Reduced margin */
        }

        .history-content {
            white-space: pre-wrap;
            margin-bottom: 6px;
            /* Reduced margin */
            color: #334155;
            line-height: 1.5;
            /* Slightly tighter than 1.6 */
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .btn-mini {
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 4px;
        }

        .btn-quote {
            background-color: #e2e8f0;
            color: #475569;
        }

        .btn-quote:hover {
            background-color: #cbd5e1;
            color: #1e293b;
        }

        .btn-delete {
            background-color: #fee2e2;
            color: #ef4444;
        }

        .btn-delete:hover {
            background-color: #fecaca;
        }

        .btn-mini-print {
            background-color: #f1f5f9;
            color: #64748b;
        }

        .btn-mini-print:hover {
            background-color: #e2e8f0;
        }

        /* --- Search Module --- */
        #search {
            background: transparent;
            /* Wrapper is transparent, elements are cards if needed, or search page is special. Let's make search container transparent but results list handled. */
            /* Actually, let's keep it consistent. The wrapper card is okay. */
            box-shadow: none;
            border: none;
            padding: 0;
            background: transparent;
        }

        .search-page-header {
            margin-bottom: 24px;
        }

        .main-search-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border-radius: 50px;
            /* Pillow shape for search */
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .search-group-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            margin: 24px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-result-item {
            background: #fff;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            border-left: 4px solid #ccc;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .search-result-item.customer {
            border-left-color: var(--accent-color);
        }

        .search-result-item.order {
            border-left-color: #eab308;
        }

        /* Yellow 500 */
        .search-result-item.payment {
            border-left-color: #10b981;
        }

        /* Emerald 500 */

        /* --- Calendar Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.4);
            /* Slate 900 with opacity */
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            width: 440px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-main);
        }

        .modal-actions {
            margin-top: 32px;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-cancel:hover {
            background: #e2e8f0;
        }

        /* --- Print --- */
        #print-container {
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #print-container,
            #print-container * {
                visibility: visible;
                display: block;
            }

            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                height: 100mm;
                font-size: 10.5pt;
                font-family: "SimHei", "é»‘ä½“", sans-serif;
                line-height: 1.4;
                padding: 5mm;
                box-sizing: border-box;
                border: 1px dashed #000;
                overflow: hidden;
            }

            @page {
                size: 80mm 100mm;
                margin: 0;
            }
        }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                overflow: auto;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                padding: 12px 16px;
                border-bottom: 1px solid var(--border-color);
                border-right: none;
                flex-shrink: 0;
                align-items: center;
                gap: 12px;
            }

            .app-title {
                margin-bottom: 0;
                font-size: 16px;
                margin-right: 12px;
                white-space: nowrap;
            }

            .nav-item {
                padding: 8px 12px;
                margin-bottom: 0;
                white-space: nowrap;
                font-size: 13px;
            }

            .main-content {
                padding: 16px;
                overflow: visible;
                height: auto;
            }

            .header-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .modal-content {
                width: 90%;
                margin: 20px;
            }

            textarea {
                height: 100px;
            }
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="app-title">å·¥ä½œè®°äº‹æœ¬</div>
        <div class="nav-item active" onclick="switchTab('customer')">ğŸ‘¥ å®¢æˆ·æ²Ÿé€š</div>
        <div class="nav-item" onclick="switchTab('order')">ğŸ“¦ è®¢å‘è´§ç®¡ç†</div>
        <div class="nav-item" onclick="switchTab('payment')">ğŸ’° æ”¶ä»˜æ¬¾ç®¡ç†</div>
        <div class="nav-item" onclick="switchTab('search')">ğŸ” å…¨å±€æœç´¢</div>
    </div>

    <div class="main-content">
        <div class="header-info">
            <span id="module-title">å®¢æˆ·æ²Ÿé€šè®°å½•</span>
            <!-- Search bar removed from here -->
            <span id="current-date"></span>
        </div>

        <div id="customer" class="module-section active">
            <div class="top-reminders">
                <div class="section-title">ğŸ“… ä»Šæ—¥éœ€è·Ÿè¿› / æé†’</div>
                <ul class="reminder-list" id="customer-reminders">
                </ul>
            </div>

            <div class="input-area">
                <div class="section-title">âœï¸ è®°äº‹å½•å…¥</div>
                <textarea id="customer-input" placeholder="è¾“å…¥å®¢æˆ·å’¨è¯¢å†…å®¹ã€æŠ¥ä»·è¯¦æƒ…æˆ–å›è®¿è®°å½•..."></textarea>
                <div class="action-bar">
                    <button class="btn-add-reminder" onclick="addReminder('customer')">è®¾ä¸ºæé†’äº‹é¡¹</button>
                    <button class="btn-print" onclick="printContent('customer')">æ‰“å°</button>
                    <button class="btn-save-log" onclick="saveLog('customer')">ä¿å­˜åˆ°å†å²</button>
                </div>
            </div>

            <div class="history-area">
                <div class="section-title">ğŸ“œ å†å²è®°å½•</div>
                <div id="customer-history"></div>
            </div>
        </div>

        <div id="order" class="module-section">
            <div class="top-reminders" style="border-left-color: #f1c40f;">
                <div class="section-title">ğŸš› ä»Šæ—¥å¾…å‘è´§ / å¾…è®¢è´§</div>
                <ul class="reminder-list" id="order-reminders"></ul>
            </div>
            <div class="input-area">
                <div class="section-title">âœï¸ ç‰©æµ/è®¢å•å½•å…¥</div>
                <textarea id="order-input" placeholder="è¾“å…¥è´§å·ã€ç‰©æµå•å·ã€å‚å®¶è®¢è´§ç¡®è®¤å·..."></textarea>
                <div class="action-bar">
                    <button class="btn-add-reminder" onclick="addReminder('order')">è®¾ä¸ºæé†’äº‹é¡¹</button>
                    <button class="btn-print" onclick="printContent('order')">æ‰“å°</button>
                    <button class="btn-save-log" onclick="saveLog('order')">ä¿å­˜åˆ°å†å²</button>
                </div>
            </div>
            <div class="history-area">
                <div class="section-title">ğŸ“œ å†å²è®°å½•</div>
                <div id="order-history"></div>
            </div>
        </div>

        <div id="payment" class="module-section">
            <div class="top-reminders" style="border-left-color: #2ecc71;">
                <div class="section-title">ğŸ’´ ä»Šæ—¥å¾…å‚¬æ¬¾ / å¾…ä»˜æ¬¾</div>
                <ul class="reminder-list" id="payment-reminders"></ul>
            </div>
            <div class="input-area">
                <div class="section-title">âœï¸ è´¢åŠ¡è®°å½•å½•å…¥</div>
                <textarea id="payment-input" placeholder="è¾“å…¥å‘ç¥¨å·ã€å›æ¬¾é‡‘é¢ã€æŠ¥è´¦æˆªæ­¢æ—¥æœŸ..."></textarea>
                <div class="action-bar">
                    <button class="btn-add-reminder" onclick="addReminder('payment')">è®¾ä¸ºæé†’äº‹é¡¹</button>
                    <button class="btn-print" onclick="printContent('payment')">æ‰“å°</button>
                    <button class="btn-save-log" onclick="saveLog('payment')">ä¿å­˜åˆ°å†å²</button>
                </div>
            </div>
            <div class="history-area">
                <div class="section-title">ğŸ“œ å†å²è®°å½•</div>
                <div id="payment-history"></div>
            </div>
        </div>

        <div id="search" class="module-section">
            <div class="search-page-header">
                <input type="text" id="main-search-input" class="main-search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢æ‰€æœ‰è®°å½•..."
                    oninput="performGlobalSearch()">
            </div>
            <div id="search-results-container" class="search-results-container">
                <!-- Results rendered here -->
            </div>
        </div>
    </div>

    <div id="print-container"></div>

    <!-- Calendar Modal -->
    <div id="calendar-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">ğŸ“… æ·»åŠ åˆ°æ—¥å†</div>
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="cal-date">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨å†…å®¹</label>
                <textarea id="cal-remark" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeCalendarModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="downloadICS()">æ·»åŠ åˆ°æ—¥å† (å¯¼å‡ºICS)</button>
            </div>
        </div>
    </div>

    <script>
        // Calendar Modal Logic
        let currentReminderText = ''; // To store the text of the reminder being added to calendar

        function openCalendarModal(reminderText) {
            currentReminderText = reminderText;
            document.getElementById('cal-remark').value = reminderText;
            // Set default date to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('cal-date').value = `${yyyy}-${mm}-${dd}`;

            document.getElementById('calendar-modal').style.display = 'flex';
        }

        function closeCalendarModal() {
            document.getElementById('calendar-modal').style.display = 'none';
        }

        function downloadICS() {
            const date = document.getElementById('cal-date').value;
            const remark = document.getElementById('cal-remark').value;

            if (!date) {
                alert('è¯·é€‰æ‹©æ—¥æœŸï¼');
                return;
            }

            const eventDate = new Date(date);
            const year = eventDate.getFullYear();
            const month = String(eventDate.getMonth() + 1).padStart(2, '0');
            const day = String(eventDate.getDate()).padStart(2, '0');

            const eventStart = `${year}${month}${day}T090000`; // 9 AM
            const eventEnd = `${year}${month}${day}T100000`; // 10 AM

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//WorkRecordApp//CN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${new Date().getTime()}@workrecordapp
DTSTAMP:${new Date().toISOString().replace(/[-:]|\.\d{3}/g, '')}Z
DTSTART:${eventStart}
DTEND:${eventEnd}
SUMMARY:${remark || 'æé†’äº‹é¡¹'}
DESCRIPTION:${remark || 'æé†’äº‹é¡¹'}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reminder_${date}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeCalendarModal();
            // User Guidance
            setTimeout(() => {
                alert('ğŸ“… æ—¥å†æ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼\n\nè¯·åœ¨æµè§ˆå™¨ä¸‹è½½æ ä¸­ç‚¹å‡»æ‰“å¼€è¯¥æ–‡ä»¶ (reminder_' + date + '.ics)ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯¢é—®æ˜¯å¦å¯¼å…¥åˆ°æ‚¨çš„æ—¥å†ã€‚');
            }, 500);
        }

        // åˆå§‹åŒ–æ—¥æœŸ
        function updateDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').innerText = now.toLocaleDateString('zh-CN', options);
        }
        updateDate();

        // æ¨¡å—åˆ‡æ¢é€»è¾‘
        function switchTab(moduleId) {
            // éšè—æ‰€æœ‰æ¨¡å—
            document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            // æ˜¾ç¤ºé€‰ä¸­æ¨¡å—
            document.getElementById(moduleId).classList.add('active');

            // æ›´æ–°å¯¼èˆªæ ·å¼
            const navIndex = { 'customer': 0, 'order': 1, 'payment': 2, 'search': 3 };
            document.querySelectorAll('.nav-item')[navIndex[moduleId]].classList.add('active');

            // æ›´æ–°æ ‡é¢˜
            const titles = { 'customer': 'å®¢æˆ·æ²Ÿé€šè®°å½•', 'order': 'è®¢å‘è´§ç®¡ç†', 'payment': 'æ”¶ä»˜æ¬¾ç®¡ç†', 'search': 'å…¨è®°å½•æœç´¢' };
            document.getElementById('module-title').innerText = titles[moduleId];

            // å¦‚æœåˆ‡å›æ™®é€šæ¨¡å—ï¼Œé‡æ–°æ¸²æŸ“å†å²ï¼ˆå–æ¶ˆä¹‹å‰çš„è¿‡æ»¤é€»è¾‘ï¼Œå› ä¸ºæœç´¢ç°åœ¨ç‹¬ç«‹äº†ï¼‰
            if (moduleId !== 'search') {
                renderHistory(moduleId);
            } else {
                // å¦‚æœåˆ‡åˆ°æœç´¢æ¨¡å—ï¼Œè‡ªåŠ¨èšç„¦
                setTimeout(() => document.getElementById('main-search-input').focus(), 100);
            }
        }

        // æ•°æ®åŠ è½½ä¸ä¿å­˜ (ä½¿ç”¨LocalStorage)
        function loadData() {
            ['customer', 'order', 'payment'].forEach(type => {
                renderHistory(type);
                renderReminders(type);
            });
        }

        // 1. æ·»åŠ æé†’ (æ˜¾ç¤ºåœ¨ä¸Šæ–¹)
        function addReminder(type) {
            const input = document.getElementById(type + '-input');
            const text = input.value.trim();
            if (!text) return alert('è¯·è¾“å…¥å†…å®¹ï¼');

            const reminders = JSON.parse(localStorage.getItem(type + '_reminders') || '[]');
            reminders.push({ text: text, done: false, date: new Date().toLocaleDateString() });
            localStorage.setItem(type + '_reminders', JSON.stringify(reminders));

            renderReminders(type);
            input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }

        function renderReminders(type) {
            const list = document.getElementById(type + '-reminders');
            const data = JSON.parse(localStorage.getItem(type + '_reminders') || '[]');
            list.innerHTML = '';

            data.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleReminder('${type}', ${index})">
                    <span style="${item.done ? 'text-decoration: line-through; color: #aaa;' : ''}">${item.text}</span>
                    <span style="font-size:10.5pt; color:#ccc; margin-left:auto;">${item.date}</span>
                    <span style="cursor:pointer; margin-left:10px; font-size:13px; color:var(--accent-color);" onclick="openCalendarModal('${item.text.replace(/'/g, "\\'")}'); event.stopPropagation();">æ—¥å†</span>
                    <span style="cursor:pointer; margin-left:10px; font-size:13px; color:#e74c3c;" onclick="deleteReminder('${type}', ${index})">åˆ é™¤</span>
                `;
                list.appendChild(li);
            });
        }

        function toggleReminder(type, index) {
            const reminders = JSON.parse(localStorage.getItem(type + '_reminders'));
            reminders[index].done = !reminders[index].done;
            localStorage.setItem(type + '_reminders', JSON.stringify(reminders));
            renderReminders(type);
        }

        function deleteReminder(type, index) {
            const reminders = JSON.parse(localStorage.getItem(type + '_reminders'));
            reminders.splice(index, 1);
            localStorage.setItem(type + '_reminders', JSON.stringify(reminders));
            renderReminders(type);
        }

        // 2. ä¿å­˜å†å²è®°å½• (æ˜¾ç¤ºåœ¨ä¸‹æ–¹)
        function saveLog(type) {
            const input = document.getElementById(type + '-input');
            const text = input.value.trim();
            if (!text) return alert('è¯·è¾“å…¥å†…å®¹ï¼');

            const logs = JSON.parse(localStorage.getItem(type + '_logs') || '[]');
            const now = new Date();
            logs.unshift({
                text: text,
                time: now.toLocaleString('zh-CN', { hour12: false })
            });

            localStorage.setItem(type + '_logs', JSON.stringify(logs));
            renderHistory(type);
            input.value = '';
        }

        function renderHistory(type) {
            const container = document.getElementById(type + '-history');
            // ç§»é™¤æ—§çš„æœç´¢è¿‡æ»¤é€»è¾‘ï¼Œç°åœ¨å…¨éƒ½åœ¨ç‹¬ç«‹æ¨¡å—
            // const searchTerm = document.getElementById('global-search').value.trim().toLowerCase();

            container.innerHTML = '';

            // é‡æ–°è·å–åŸå§‹æ•°æ®ç”¨äºæ˜¾ç¤ºï¼Œè¿™æ ·èƒ½æ‹¿åˆ°æ­£ç¡®çš„åˆ é™¤ç´¢å¼•
            const allLogs = JSON.parse(localStorage.getItem(type + '_logs') || '[]');

            allLogs.forEach((log, realIndex) => {
                // if (searchTerm && !log.text.toLowerCase().includes(searchTerm)) {
                //     return; // è·³è¿‡ä¸åŒ¹é…çš„
                // }

                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-time">${log.time}</div>
                    <div class="history-content">${log.text}</div>
                    <div class="history-actions">
                        <button class="btn-mini btn-quote" onclick="quoteLog('${type}', ${realIndex})">å¼•ç”¨</button>
                        <button class="btn-mini btn-delete" onclick="deleteLog('${type}', ${realIndex})">åˆ é™¤</button>
                        <button class="btn-mini btn-mini-print" onclick="printOneLog('${log.text.replace(/'/g, "\\'")}', '${log.time}')">æ‰“å°</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }



        // --- Global Search Module Logic ---
        function performGlobalSearch() {
            const query = document.getElementById('main-search-input').value.trim().toLowerCase();
            const container = document.getElementById('search-results-container');
            container.innerHTML = '';

            if (!query) {
                container.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">è¯·è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>';
                return;
            }

            const modules = [
                { id: 'customer', name: 'ğŸ‘¥ å®¢æˆ·æ²Ÿé€š' },
                { id: 'order', name: 'ğŸ“¦ è®¢å‘è´§' },
                { id: 'payment', name: 'ğŸ’° æ”¶ä»˜æ¬¾' }
            ];

            let foundAny = false;

            modules.forEach(mod => {
                const logs = JSON.parse(localStorage.getItem(mod.id + '_logs') || '[]');
                // æœç´¢åŒ¹é…
                const matches = logs.map((log, index) => ({ ...log, originalIndex: index })) // ä¿ç•™åŸå§‹ç´¢å¼•
                    .filter(log => log.text.toLowerCase().includes(query));

                if (matches.length > 0) {
                    foundAny = true;
                    // Render Group Header
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'search-group-title';
                    groupTitle.innerText = mod.name;
                    container.appendChild(groupTitle);

                    // Render Items
                    matches.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `search-result-item ${mod.id}`;
                        // ç‚¹å‡»æ•´ä¸ªæ¡ç›®è·³è½¬å»æŸ¥çœ‹ (æš‚å®šåªè¦ç‚¹å‡»éæŒ‰é’®åŒºåŸŸ)
                        div.innerHTML = `
                            <div class="history-time">${item.time}</div>
                            <div class="history-content">${item.text}</div>
                            <div class="history-actions">
                                <button class="btn-mini btn-quote" onclick="jumpAndQuote('${mod.id}', ${item.originalIndex}); event.stopPropagation();">å¼•ç”¨å¹¶ç¼–è¾‘</button>
                                <button class="btn-mini btn-delete" onclick="deleteFromSearch('${mod.id}', ${item.originalIndex}); event.stopPropagation();">åˆ é™¤</button>
                                <button class="btn-mini btn-mini-print" onclick="printOneLog('${item.text.replace(/'/g, "\\'")}', '${item.time}'); event.stopPropagation();">æ‰“å°</button>
                            </div>
                        `;
                        div.onclick = () => switchTab(mod.id); // ç®€å•è·³è½¬
                        container.appendChild(div);
                    });
                }
            });

            if (!foundAny) {
                container.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">æœªæ‰¾åˆ°åŒ¹é…è®°å½•</div>';
            }
        }

        function jumpAndQuote(type, index) {
            // åˆ‡æ¢åˆ°å¯¹åº”æ¨¡å—
            switchTab(type);
            // è°ƒç”¨å¼•ç”¨é€»è¾‘
            quoteLog(type, index);
        }

        function deleteFromSearch(type, index) {
            if (!confirm('ç¡®å®šä»å†å²è®°å½•ä¸­åˆ é™¤è¿™æ¡å—ï¼Ÿ')) return;

            const logs = JSON.parse(localStorage.getItem(type + '_logs') || '[]');
            logs.splice(index, 1); // è¿™é‡Œçš„indexå¿…é¡»æ˜¯åŸå§‹æ•°æ®çš„index
            localStorage.setItem(type + '_logs', JSON.stringify(logs));

            // é‡æ–°æœç´¢åˆ·æ–°é¡µé¢
            performGlobalSearch();

            // å¦‚æœè¿™æ—¶å€™åˆ‡å›å»ï¼ŒåŸåˆ—è¡¨ä¹Ÿåº”è¯¥æ›´æ–°(renderHistoryæ¯æ¬¡åˆ‡æ¢éƒ½ä¼šè°ƒ)
        }

        // æ—§çš„handleSearchä¸å†éœ€è¦äº†
        // function handleSearch() { ... }

        function quoteLog(type, index) {
            const logs = JSON.parse(localStorage.getItem(type + '_logs') || '[]');
            const log = logs[index];
            if (log) {
                const input = document.getElementById(type + '-input');
                input.value = log.text; // æˆ–è€… += è¿½åŠ 
            }
        }

        function deleteLog(type, index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            const logs = JSON.parse(localStorage.getItem(type + '_logs') || '[]');
            logs.splice(index, 1);
            localStorage.setItem(type + '_logs', JSON.stringify(logs));
            renderHistory(type);
        }

        function printOneLog(text, time) {
            const printDiv = document.getElementById('print-container');
            printDiv.innerHTML = `
                <div style="font-weight:bold; border-bottom:2px solid black; margin-bottom:5px;">å·¥ä½œå¤‡å¿˜å•</div>
                <div style="font-size: 9pt; margin-bottom: 10px;">è®°å½•æ—¶é—´: ${time}</div>
                <div style="white-space: pre-wrap;">${text}</div>
            `;
            window.print();
        }

        // 3. æ‰“å°åŠŸèƒ½ (æ ¸å¿ƒè¦æ±‚ï¼š80x100mm, 5å·é»‘ä½“)
        function printContent(type) {
            const input = document.getElementById(type + '-input');
            const text = input.value.trim();

            if (!text) return alert('è¾“å…¥æ¡†ä¸ºç©ºï¼Œæ— æ³•æ‰“å°ã€‚è¯·å…ˆè¾“å…¥å†…å®¹ã€‚');

            const printDiv = document.getElementById('print-container');
            const date = new Date().toLocaleString('zh-CN');

            // æ„é€ æ‰“å°å†…å®¹
            printDiv.innerHTML = `
                <div style="font-weight:bold; border-bottom:2px solid black; margin-bottom:5px;">å·¥ä½œå¤‡å¿˜å•</div>
                <div style="font-size: 9pt; margin-bottom: 10px;">æ‰“å°æ—¶é—´: ${date}</div>
                <div style="white-space: pre-wrap;">${text}</div>
            `;

            window.print();
        }

        // é¡µé¢åŠ è½½æ—¶è¯»å–æ•°æ®
        loadData();
    </script>
</body>

</html>